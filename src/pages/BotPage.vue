<script setup lang="ts">
import { ref, computed, onMounted, nextTick } from 'vue';
import axios from 'axios';
import JSZip from 'jszip';
import { Button, Switch, Card } from '@/components/ui';

// Auth API (Playwright ë°±ì—”ë“œ)
const authApi = axios.create({
  baseURL: import.meta.env.VITE_API_URL || 'http://localhost:8000',
  timeout: 60000,
});

type LoginStatus = 'LOGGED_OUT' | 'LOGGING_IN' | 'LOGGED_IN' | 'ERROR';
type LogType = 'INFO' | 'SUCCESS' | 'ERROR' | 'WARNING';

interface LogEntry {
  id: string;
  type: LogType;
  message: string;
  detail?: string;
  timestamp: number;
}

// ì›¹ ì•±ì—ì„œëŠ” ì§ì ‘ì…ë ¥ ëª¨ë“œ ì‚¬ìš© (í”„ë¦¬ì…‹ì€ extensionì—ì„œë§Œ ì‚¬ìš©)
const ACCOUNTS: Array<{ id: string; password: string }> = [];

// ì„¸ì…˜ ê´€ë¦¬
const sessionId = ref<string | null>(null);
const cookies = ref<Record<string, string> | null>(null);

// ë¡œê·¸
const logs = ref<LogEntry[]>([]);
const logContainer = ref<HTMLElement | null>(null);

const addLog = (type: LogType, message: string, detail?: string) => {
  const entry: LogEntry = {
    id: `${Date.now()}-${Math.random().toString(36).substring(2, 5)}`,
    type,
    message,
    detail,
    timestamp: Date.now(),
  };
  logs.value.push(entry);

  if (logs.value.length > 100) {
    logs.value = logs.value.slice(-100);
  }

  nextTick(() => {
    if (logContainer.value) {
      logContainer.value.scrollTop = logContainer.value.scrollHeight;
    }
  });
};

const clearLogs = () => {
  logs.value = [];
};

// ìƒíƒœ
const loginStatus = ref<LoginStatus>('LOGGED_OUT');
const currentAccountIndex = ref(0);
const isLoginLoading = ref(false);

// ê³„ì • ì…ë ¥ ëª¨ë“œ (false: í”„ë¦¬ì…‹, true: ì§ì ‘ì…ë ¥)
const useManualAccount = ref(false);
const manualId = ref('');
const manualPassword = ref('');

// í˜„ì¬ ì‚¬ìš©í•  ê³„ì •
const currentAccount = computed(() => {
  if (useManualAccount.value) {
    return { id: manualId.value.trim(), password: manualPassword.value };
  }
  return ACCOUNTS[currentAccountIndex.value] || null;
});

// ë°œí–‰ ê´€ë ¨
const isPublishing = ref(false);
const isBotRunning = ref(false);
const publishCount = ref(5);
const postsPerAccount = ref(10);

const autoGenerateDraft = ref(false); // false: ë¡œì»¬ ì›ê³  ì‚¬ìš©, true: ì›ê³  ìë™ìƒì„±
const autoSchedule = ref(false);

// ì›ê³  ìë™ìƒì„± ì˜µì…˜
const keywords = ref('');
const service = ref('');
const refText = ref('');
const generateImages = ref(true);
const imageCount = ref(5);
const delayBetweenPosts = ref(60);

// í´ë” ì—…ë¡œë“œ ê´€ë ¨
interface UploadedFolder {
  name: string;
  manuscriptFile: File | null;
  imageFiles: File[];
}
const uploadedFolderList = ref<UploadedFolder[]>([]);
const isUploading = ref(false);
const isDragOver = ref(false);

// ë“œë˜ê·¸ì•¤ë“œë í•¸ë“¤ëŸ¬
const handleDragOver = (e: DragEvent) => {
  e.preventDefault();
  isDragOver.value = true;
};

const handleDragLeave = () => {
  isDragOver.value = false;
};

const handleDrop = async (e: DragEvent) => {
  e.preventDefault();
  isDragOver.value = false;

  const items = e.dataTransfer?.items;
  if (!items) return;

  for (const item of Array.from(items)) {
    if (item.kind === 'file') {
      const entry = item.webkitGetAsEntry();
      if (entry?.isDirectory) {
        await processDirectory(entry as FileSystemDirectoryEntry);
      }
    }
  }
};

const processDirectory = async (dirEntry: FileSystemDirectoryEntry) => {
  const folderName = dirEntry.name;
  const folder: UploadedFolder = {
    name: folderName,
    manuscriptFile: null,
    imageFiles: [],
  };

  const readEntries = (reader: FileSystemDirectoryReader): Promise<FileSystemEntry[]> => {
    return new Promise((resolve, reject) => {
      reader.readEntries(resolve, reject);
    });
  };

  const getFile = (fileEntry: FileSystemFileEntry): Promise<File> => {
    return new Promise((resolve, reject) => {
      fileEntry.file(resolve, reject);
    });
  };

  const processEntry = async (entry: FileSystemEntry, path = '') => {
    if (entry.isFile) {
      const fileEntry = entry as FileSystemFileEntry;
      const file = await getFile(fileEntry);
      const fullPath = path + entry.name;

      if (file.name.endsWith('.txt')) {
        folder.manuscriptFile = file;
      } else if (file.type.startsWith('image/') || /\.(jpg|jpeg|png|gif|webp)$/i.test(file.name)) {
        folder.imageFiles.push(file);
      }
    } else if (entry.isDirectory) {
      const dirReader = (entry as FileSystemDirectoryEntry).createReader();
      const entries = await readEntries(dirReader);
      for (const subEntry of entries) {
        await processEntry(subEntry, path + entry.name + '/');
      }
    }
  };

  const reader = dirEntry.createReader();
  const entries = await readEntries(reader);
  for (const entry of entries) {
    await processEntry(entry);
  }

  if (folder.manuscriptFile || folder.imageFiles.length > 0) {
    uploadedFolderList.value.push(folder);
    addLog('INFO', `í´ë” ì¶”ê°€: ${folderName}`, `ì›ê³ : ${folder.manuscriptFile ? 'ìˆìŒ' : 'ì—†ìŒ'}, ì´ë¯¸ì§€: ${folder.imageFiles.length}ê°œ`);
  }
};

const removeFolder = (index: number) => {
  const removed = uploadedFolderList.value.splice(index, 1);
  if (removed.length > 0) {
    addLog('INFO', `í´ë” ì œê±°: ${removed[0].name}`);
  }
};

const clearFolderList = () => {
  uploadedFolderList.value = [];
  addLog('INFO', 'í´ë” ëª©ë¡ ì´ˆê¸°í™”');
};

// í´ë”ë“¤ì„ ZIPìœ¼ë¡œ ì••ì¶•í•´ì„œ ì—…ë¡œë“œ
const handleUploadFolders = async () => {
  if (uploadedFolderList.value.length === 0) {
    addLog('ERROR', 'ì—…ë¡œë“œí•  í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤');
    return;
  }

  isUploading.value = true;
  addLog('INFO', 'ZIP ì••ì¶• ë° ì—…ë¡œë“œ ì‹œì‘...', `${uploadedFolderList.value.length}ê°œ í´ë”`);

  try {
    const zip = new JSZip();

    for (const folder of uploadedFolderList.value) {
      const folderZip = zip.folder(folder.name);
      if (!folderZip) continue;

      if (folder.manuscriptFile) {
        const content = await folder.manuscriptFile.text();
        folderZip.file(`${folder.name}.txt`, content);
      }

      if (folder.imageFiles.length > 0) {
        const imagesFolder = folderZip.folder('images');
        for (const img of folder.imageFiles) {
          const buffer = await img.arrayBuffer();
          imagesFolder?.file(img.name, buffer);
        }
      }
    }

    const zipBlob = await zip.generateAsync({ type: 'blob' });
    const formData = new FormData();
    formData.append('file', zipBlob, 'manuscripts.zip');

    const response = await authApi.post('/bot/upload-zip', formData, {
      headers: { 'Content-Type': 'multipart/form-data' },
      timeout: 120000,
    });

    const { success, uploaded = 0, message, error } = response.data;

    if (success) {
      addLog('SUCCESS', 'ì—…ë¡œë“œ ì™„ë£Œ', `${uploaded}ê°œ í´ë” ì—…ë¡œë“œë¨`);
      uploadedFolderList.value = [];
    } else {
      addLog('ERROR', 'ì—…ë¡œë“œ ì‹¤íŒ¨', error || message);
    }
  } catch (error: unknown) {
    const axiosError = error as { message?: string };
    addLog('ERROR', 'ì—…ë¡œë“œ ì‹¤íŒ¨', axiosError.message);
  } finally {
    isUploading.value = false;
  }
};

// í‚¤ì›Œë“œ íŒŒì‹± (ì¤„ë°”ê¿ˆ/ì‰¼í‘œ êµ¬ë¶„)
const keywordList = computed(() => {
  return keywords.value
    .split(/[\n,]+/)
    .map(k => k.trim())
    .filter(Boolean);
});

// ì˜¤ëŠ˜ ë‚ ì§œ & ë‹¤ìŒ ì‹œê°„ ê¸°ë³¸ê°’ (í˜„ì¬ ì‹œê°„ì€ ì´ë¯¸ ì§€ë‚¬ìœ¼ë¯€ë¡œ +1)
const now = new Date();
const today = now.toISOString().split('T')[0];
const nextHour = (now.getHours() + 1) % 24;

const scheduleDate = ref(today);
const scheduleStartHour = ref(nextHour);
const scheduleIntervalHours = ref(1);
const scheduleIntervalMinutes = ref(0);

const loginStatusLabel = computed(() => {
  const labels: Record<LoginStatus, string> = {
    LOGGED_OUT: 'ë¡œê·¸ì•„ì›ƒ',
    LOGGING_IN: 'ë¡œê·¸ì¸ ì¤‘...',
    LOGGED_IN: 'ë¡œê·¸ì¸ë¨',
    ERROR: 'ì˜¤ë¥˜',
  };
  return labels[loginStatus.value];
});

const loginStatusClass = computed(() => {
  const classes: Record<LoginStatus, string> = {
    LOGGED_OUT: 'status-out',
    LOGGING_IN: 'status-loading',
    LOGGED_IN: 'status-in',
    ERROR: 'status-error',
  };
  return classes[loginStatus.value];
});

const handleLogin = async () => {
  if (isLoginLoading.value) return;

  const account = currentAccount.value;
  if (!account?.id || !account?.password) {
    addLog('ERROR', 'ê³„ì • ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤', useManualAccount.value ? 'ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”' : 'ACCOUNTS ë°°ì—´ì— ê³„ì •ì„ ì¶”ê°€í•˜ì„¸ìš”');
    return;
  }

  isLoginLoading.value = true;
  loginStatus.value = 'LOGGING_IN';
  addLog('INFO', 'ë„¤ì´ë²„ ë¡œê·¸ì¸ ì‹œë„ ì¤‘...', `ê³„ì •: ${account.id}`);

  try {
    const response = await authApi.post('/auth/naver/login', {
      id: account.id,
      password: account.password,
    });

    const { success, sessionId: sid, cookies: responseCookies, message, error } = response.data;

    if (success) {
      sessionId.value = sid;
      cookies.value = responseCookies || null;
      loginStatus.value = 'LOGGED_IN';
      addLog('SUCCESS', 'ë„¤ì´ë²„ ë¡œê·¸ì¸ ì„±ê³µ', message);
      if (responseCookies) {
        addLog('INFO', 'ì¿ í‚¤ ì €ì¥ ì™„ë£Œ', `${Object.keys(responseCookies).length}ê°œ`);
      }
    } else {
      loginStatus.value = 'ERROR';
      addLog('ERROR', 'ë„¤ì´ë²„ ë¡œê·¸ì¸ ì‹¤íŒ¨', error || message);
    }
  } catch (error: unknown) {
    const axiosError = error as { code?: string; message?: string };
    const isTimeout = axiosError.code === 'ECONNABORTED' || axiosError.message?.includes('timeout');
    loginStatus.value = 'ERROR';
    if (!isTimeout) {
      addLog('ERROR', 'ë„¤ì´ë²„ ë¡œê·¸ì¸ ì‹¤íŒ¨', axiosError.message);
    }
  } finally {
    isLoginLoading.value = false;
  }
};

const handleLogout = async () => {
  if (isLoginLoading.value) return;
  isLoginLoading.value = true;
  addLog('INFO', 'ë„¤ì´ë²„ ë¡œê·¸ì•„ì›ƒ ì‹œë„ ì¤‘...');

  try {
    if (sessionId.value) {
      await authApi.post('/auth/naver/logout', {
        sessionId: sessionId.value,
      });
    }

    sessionId.value = null;
    cookies.value = null;
    loginStatus.value = 'LOGGED_OUT';
    addLog('SUCCESS', 'ë„¤ì´ë²„ ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
  } catch (error: unknown) {
    const axiosError = error as { message?: string };
    addLog('WARNING', 'ë¡œê·¸ì•„ì›ƒ API ì—ëŸ¬ (ë¡œì»¬ ì„¸ì…˜ì€ ì‚­ì œë¨)', axiosError.message);
    sessionId.value = null;
    cookies.value = null;
    loginStatus.value = 'LOGGED_OUT';
  } finally {
    isLoginLoading.value = false;
  }
};

const formatTime = (timestamp: number) => {
  return new Date(timestamp).toLocaleTimeString('ko-KR', {
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
  });
};

const getLogClass = (type: LogType) => {
  const classes: Record<LogType, string> = {
    INFO: 'log-info',
    SUCCESS: 'log-success',
    ERROR: 'log-error',
    WARNING: 'log-warning',
  };
  return classes[type];
};

const getLogIcon = (type: LogType) => {
  const icons: Record<LogType, string> = {
    INFO: 'â„¹ï¸',
    SUCCESS: 'âœ…',
    ERROR: 'âŒ',
    WARNING: 'âš ï¸',
  };
  return icons[type];
};

const checkAuthApiHealth = async () => {
  try {
    const response = await authApi.get('/auth/naver/health');
    if (response.data?.status === 'ok') {
      addLog('SUCCESS', 'Auth API ì—°ê²°ë¨', authApi.defaults.baseURL);
    }
  } catch {
    addLog('WARNING', 'Auth API ì—°ê²° ì‹¤íŒ¨', `${authApi.defaults.baseURL} - ë°±ì—”ë“œ ì„œë²„ ì‹¤í–‰ í•„ìš”`);
  }
};

// ë°œí–‰í•˜ê¸°
const handlePublish = async () => {
  if (isPublishing.value) return;

  if (!cookies.value) {
    addLog('ERROR', 'ë°œí–‰ ì‹¤íŒ¨', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
    return;
  }

  isPublishing.value = true;
  addLog('INFO', 'ë¸”ë¡œê·¸ ë°œí–‰ ì‹œì‘...');

  try {
    const response = await authApi.post('/bot/publish', {
      cookies: cookies.value,
      count: publishCount.value,
      auto_generate_draft: autoGenerateDraft.value,
      use_schedule: autoSchedule.value,
      schedule_date: scheduleDate.value || undefined,
      schedule_start_hour: scheduleStartHour.value,
      schedule_interval_hours: scheduleIntervalHours.value,
      schedule_interval_minutes: scheduleIntervalMinutes.value,
    });

    const { success, published = 0, message, error } = response.data;

    if (success) {
      addLog('SUCCESS', 'ë°œí–‰ ì™„ë£Œ', `${published}ê°œ ë°œí–‰ë¨`);
    } else {
      addLog('ERROR', 'ë°œí–‰ ì‹¤íŒ¨', error || message);
    }
  } catch (error: unknown) {
    const axiosError = error as { code?: string; message?: string };
    const isTimeout = axiosError.code === 'ECONNABORTED' || axiosError.message?.includes('timeout');
    if (!isTimeout) {
      addLog('ERROR', 'ë°œí–‰ ì‹¤íŒ¨', axiosError.message);
    }
  } finally {
    isPublishing.value = false;
  }
};

// ì „ì²´ ìë™í™” ì‹œì‘
const handleStartBot = async () => {
  if (isBotRunning.value) return;

  if (ACCOUNTS.length === 0) {
    addLog('ERROR', 'ìë™í™” ì‹¤íŒ¨', 'ê³„ì • ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤');
    return;
  }

  isBotRunning.value = true;
  addLog('INFO', 'ìë™í™” ë´‡ ì‹œì‘...', `${ACCOUNTS.length}ê°œ ê³„ì •`);

  try {
    const response = await authApi.post('/bot/start', {
      accounts: ACCOUNTS.map(acc => ({ id: acc.id, password: acc.password })),
      posts_per_account: postsPerAccount.value,
    });

    const { success, message, error, results } = response.data;

    if (success) {
      addLog('SUCCESS', 'ìë™í™” ì™„ë£Œ', message);
      if (results) {
        results.forEach((r: { account: string; published: number; error?: string }) => {
          if (r.error) {
            addLog('WARNING', `${r.account}`, r.error);
          } else {
            addLog('INFO', `${r.account}`, `${r.published}ê°œ ë°œí–‰`);
          }
        });
      }
    } else {
      addLog('ERROR', 'ìë™í™” ì‹¤íŒ¨', error || message);
    }
  } catch (error: unknown) {
    const axiosError = error as { code?: string; message?: string };
    const isTimeout = axiosError.code === 'ECONNABORTED' || axiosError.message?.includes('timeout');
    if (!isTimeout) {
      addLog('ERROR', 'ìë™í™” ì‹¤íŒ¨', axiosError.message);
    }
  } finally {
    isBotRunning.value = false;
  }
};

// ìë™í™” ì¤‘ì§€
const handleStopBot = () => {
  addLog('WARNING', 'ìë™í™” ì¤‘ì§€ ìš”ì²­');
  isBotRunning.value = false;
};

// ì›ê³  ìë™ìƒì„± + ë°œí–‰ (ì „ì²´ ìë™í™”)
const handleAutoBot = async () => {
  if (isBotRunning.value) return;

  const account = currentAccount.value;
  if (!account?.id || !account?.password) {
    addLog('ERROR', 'ê³„ì • ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤', useManualAccount.value ? 'ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”' : 'ACCOUNTS ë°°ì—´ì— ê³„ì •ì„ ì¶”ê°€í•˜ì„¸ìš”');
    return;
  }

  if (keywordList.value.length === 0) {
    addLog('ERROR', 'í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
    return;
  }

  isBotRunning.value = true;
  addLog('INFO', 'ì „ì²´ ìë™í™” ì‹œì‘...', `${keywordList.value.length}ê°œ í‚¤ì›Œë“œ`);

  try {
    const response = await authApi.post('/bot/auto', {
      account: { id: account.id, password: account.password },
      keywords: keywordList.value,
      service: service.value || 'default',
      ref: refText.value,
      generate_images: generateImages.value,
      image_count: imageCount.value,
      use_schedule: autoSchedule.value,
      schedule_date: scheduleDate.value || undefined,
      schedule_start_hour: scheduleStartHour.value,
      schedule_interval_hours: scheduleIntervalHours.value,
      schedule_interval_minutes: scheduleIntervalMinutes.value,
      delay_between_posts: delayBetweenPosts.value,
    });

    const { success, generated = 0, published = 0, failed = 0, elapsed, results, error, message } = response.data;

    if (success) {
      addLog('SUCCESS', 'ì „ì²´ ìë™í™” ì™„ë£Œ', `ìƒì„±: ${generated}, ë°œí–‰: ${published}, ì‹¤íŒ¨: ${failed}, ì†Œìš”: ${elapsed?.toFixed(1)}ì´ˆ`);
      if (results) {
        results.forEach((r: { manuscript_id: string; success: boolean; post_url?: string; error?: string }) => {
          if (r.success) {
            addLog('INFO', `ì›ê³  ${r.manuscript_id}`, r.post_url);
          } else {
            addLog('WARNING', `ì›ê³  ${r.manuscript_id}`, r.error);
          }
        });
      }
      keywords.value = '';
    } else {
      addLog('ERROR', 'ì „ì²´ ìë™í™” ì‹¤íŒ¨', error || message);
    }
  } catch (error: unknown) {
    const axiosError = error as { code?: string; message?: string };
    const isTimeout = axiosError.code === 'ECONNABORTED' || axiosError.message?.includes('timeout');
    if (!isTimeout) {
      addLog('ERROR', 'ì „ì²´ ìë™í™” ì‹¤íŒ¨', axiosError.message);
    }
  } finally {
    isBotRunning.value = false;
  }
};

onMounted(() => {
  addLog('INFO', 'ë´‡ í˜ì´ì§€ ì´ˆê¸°í™”');
  checkAuthApiHealth();
});
</script>

<template>
  <div class="bot-page">
    <div class="bot-container">
      <!-- ì™¼ìª½: ì„¤ì • íŒ¨ë„ -->
      <div class="settings-panel">
        <Card class="panel-card">
          <!-- ë¡œê·¸ì¸ ì¹´ë“œ -->
          <div class="section login-section">
            <div class="section-header">
              <h3 class="section-title">ë„¤ì´ë²„ ê³„ì •</h3>
              <span :class="['status-badge', loginStatusClass]">
                {{ loginStatusLabel }}
              </span>
            </div>

            <!-- ê³„ì • ëª¨ë“œ í† ê¸€ -->
            <div class="account-mode-toggle">
              <button
                :class="['mode-btn', { active: !useManualAccount }]"
                @click="useManualAccount = false"
              >
                í”„ë¦¬ì…‹
              </button>
              <button
                :class="['mode-btn', { active: useManualAccount }]"
                @click="useManualAccount = true"
              >
                ì§ì ‘ì…ë ¥
              </button>
            </div>

            <!-- í”„ë¦¬ì…‹ ëª¨ë“œ -->
            <div v-if="!useManualAccount" class="login-content">
              <div class="account-display">
                <span class="account-id">{{ ACCOUNTS[currentAccountIndex]?.id || 'ê³„ì • ì—†ìŒ' }}</span>
                <span v-if="ACCOUNTS.length > 1" class="account-count">
                  {{ currentAccountIndex + 1 }} / {{ ACCOUNTS.length }}
                </span>
              </div>
              <Button
                v-if="loginStatus !== 'LOGGED_IN'"
                size="sm"
                color="primary"
                :loading="isLoginLoading"
                class="login-btn"
                @click="handleLogin"
              >
                ë¡œê·¸ì¸
              </Button>
              <Button
                v-else
                size="sm"
                color="light"
                :loading="isLoginLoading"
                class="login-btn"
                @click="handleLogout"
              >
                ë¡œê·¸ì•„ì›ƒ
              </Button>
            </div>

            <!-- ì§ì ‘ì…ë ¥ ëª¨ë“œ -->
            <div v-else class="manual-login-form">
              <div class="form-field">
                <input
                  v-model="manualId"
                  type="text"
                  class="field-input"
                  placeholder="ë„¤ì´ë²„ ì•„ì´ë””"
                  :disabled="loginStatus === 'LOGGED_IN'"
                />
              </div>
              <div class="form-field">
                <input
                  v-model="manualPassword"
                  type="password"
                  class="field-input"
                  placeholder="ë¹„ë°€ë²ˆí˜¸"
                  :disabled="loginStatus === 'LOGGED_IN'"
                />
              </div>
              <Button
                v-if="loginStatus !== 'LOGGED_IN'"
                size="sm"
                color="primary"
                display="full"
                :loading="isLoginLoading"
                :disabled="!manualId || !manualPassword"
                @click="handleLogin"
              >
                ë¡œê·¸ì¸
              </Button>
              <Button
                v-else
                size="sm"
                color="light"
                display="full"
                :loading="isLoginLoading"
                @click="handleLogout"
              >
                ë¡œê·¸ì•„ì›ƒ
              </Button>
            </div>
          </div>

          <!-- êµ¬ë¶„ì„  -->
          <div class="divider" />

          <!-- ì˜µì…˜ ì„¹ì…˜ -->
          <div class="section options-section">
            <h3 class="section-title">ë°œí–‰ ì˜µì…˜</h3>
            <div class="options-grid">
              <label class="option-card">
                <Switch v-model="autoGenerateDraft" size="sm" />
                <div class="option-info">
                  <span class="option-name">ì›ê³  ìë™ìƒì„±</span>
                  <span class="option-desc">{{ autoGenerateDraft ? 'AI ì›ê³  ìƒì„±' : 'ë¡œì»¬ ì›ê³  ì‚¬ìš©' }}</span>
                </div>
              </label>
              <label class="option-card">
                <Switch v-model="autoSchedule" size="sm" />
                <div class="option-info">
                  <span class="option-name">ì˜ˆì•½ ë°œí–‰</span>
                  <span class="option-desc">ì§€ì • ì‹œê°„ì— ë°œí–‰</span>
                </div>
              </label>
            </div>
          </div>

          <!-- ë¡œì»¬ ì›ê³  ì—…ë¡œë“œ (autoGenerateDraft = false) -->
          <div v-if="!autoGenerateDraft" class="section upload-section">
            <h3 class="section-title">ì›ê³  í´ë” ì—…ë¡œë“œ</h3>
            <div
              class="drop-zone"
              :class="{ 'drop-zone-active': isDragOver }"
              @dragover="handleDragOver"
              @dragleave="handleDragLeave"
              @drop="handleDrop"
            >
              <div class="drop-zone-content">
                <span class="drop-icon">ğŸ“</span>
                <p class="drop-text">í´ë”ë¥¼ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                <p class="drop-hint">í´ë” ì•ˆì— ì›ê³ .txt + images/ êµ¬ì¡°</p>
              </div>
            </div>

            <!-- ì—…ë¡œë“œëœ í´ë” ëª©ë¡ -->
            <div v-if="uploadedFolderList.length > 0" class="folder-list">
              <div class="folder-list-header">
                <span class="folder-count">{{ uploadedFolderList.length }}ê°œ í´ë”</span>
                <button class="clear-folder-btn" @click="clearFolderList">ì „ì²´ ì‚­ì œ</button>
              </div>
              <ul class="folder-items">
                <li v-for="(folder, index) in uploadedFolderList" :key="folder.name" class="folder-item">
                  <div class="folder-info">
                    <span class="folder-name">{{ folder.name }}</span>
                    <span class="folder-meta">
                      {{ folder.manuscriptFile ? 'ğŸ“„' : 'âŒ' }}
                      {{ folder.imageFiles.length }}ì¥
                    </span>
                  </div>
                  <button class="remove-folder-btn" @click="removeFolder(index)">Ã—</button>
                </li>
              </ul>
              <Button
                display="full"
                size="md"
                color="primary"
                :loading="isUploading"
                class="upload-btn"
                @click="handleUploadFolders"
              >
                ì„œë²„ì— ì—…ë¡œë“œ
              </Button>
            </div>
          </div>

          <!-- ì›ê³  ìë™ìƒì„± ì„¤ì • -->
          <div v-if="autoGenerateDraft" class="section generate-section">
            <h3 class="section-title">ì›ê³  ìƒì„± ì„¤ì •</h3>
            <div class="generate-form">
              <div class="form-field">
                <label class="field-label">í‚¤ì›Œë“œ (í•„ìˆ˜)</label>
                <textarea
                  v-model="keywords"
                  class="field-textarea"
                  placeholder="í‚¤ì›Œë“œ ì…ë ¥ (ì¤„ë°”ê¿ˆ ë˜ëŠ” ì‰¼í‘œë¡œ êµ¬ë¶„)&#10;ì˜ˆ: ìœ„ê³ ë¹„ íš¨ê³¼&#10;ìœ„ê³ ë¹„ ë¶€ì‘ìš©&#10;ìœ„ê³ ë¹„ ê°€ê²©"
                  rows="4"
                />
                <span class="field-hint">{{ keywordList.length }}ê°œ í‚¤ì›Œë“œ</span>
              </div>
              <div class="form-row">
                <div class="form-field">
                  <label class="field-label">ì¹´í…Œê³ ë¦¬</label>
                  <input
                    v-model="service"
                    type="text"
                    class="field-input"
                    placeholder="ì˜ˆ: ìœ„ê³ ë¹„"
                  />
                </div>
                <div class="form-field">
                  <label class="field-label">ì´ë¯¸ì§€ ìˆ˜</label>
                  <input
                    v-model.number="imageCount"
                    type="number"
                    min="1"
                    max="10"
                    class="field-input"
                  />
                </div>
              </div>
              <div class="form-field">
                <label class="field-label">ì°¸ì¡° ì›ê³  (ì„ íƒ)</label>
                <textarea
                  v-model="refText"
                  class="field-textarea"
                  placeholder="ì°¸ì¡°í•  ì›ê³  ë‚´ìš© (ì„ íƒ)"
                  rows="3"
                />
              </div>
              <div class="form-row">
                <label class="option-item-inline">
                  <Switch v-model="generateImages" size="sm" />
                  <span>ì´ë¯¸ì§€ ìƒì„±</span>
                </label>
                <div class="form-field-inline">
                  <label class="field-label">ëŒ€ê¸°ì‹œê°„(ì´ˆ)</label>
                  <input
                    v-model.number="delayBetweenPosts"
                    type="number"
                    min="10"
                    max="300"
                    class="field-input-sm"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- ì˜ˆì•½ ì„¤ì • -->
          <div v-if="autoSchedule" class="section schedule-section">
            <h3 class="section-title">ì˜ˆì•½ ì„¤ì •</h3>
            <div class="schedule-grid">
              <div class="schedule-field">
                <label class="field-label">ë°œí–‰ ë‚ ì§œ</label>
                <input
                  v-model="scheduleDate"
                  type="date"
                  :min="today"
                  class="field-input date-input"
                />
              </div>
              <div class="schedule-field">
                <label class="field-label">ì‹œì‘ ì‹œê°„</label>
                <div class="time-input-wrap">
                  <input
                    v-model.number="scheduleStartHour"
                    type="number"
                    min="0"
                    max="23"
                    class="field-input time-input"
                  />
                  <span class="time-suffix">ì‹œ</span>
                </div>
              </div>
              <div class="schedule-field">
                <label class="field-label">ê°„ê²© (ì‹œê°„)</label>
                <input
                  v-model.number="scheduleIntervalHours"
                  type="number"
                  min="0"
                  max="24"
                  class="field-input"
                />
              </div>
              <div class="schedule-field">
                <label class="field-label">ê°„ê²© (ë¶„)</label>
                <input
                  v-model.number="scheduleIntervalMinutes"
                  type="number"
                  min="0"
                  max="59"
                  class="field-input"
                />
              </div>
            </div>
            <p class="schedule-hint">ë¶„ ê°’ì´ 0ë³´ë‹¤ í¬ë©´ ë¶„ ë‹¨ìœ„ê°€ ìš°ì„  ì ìš©ë©ë‹ˆë‹¤</p>
          </div>

          <!-- êµ¬ë¶„ì„  -->
          <div class="divider" />

          <!-- ì•¡ì…˜ ë²„íŠ¼ -->
          <div class="section action-section">
            <div class="action-buttons">
              <!-- ë¡œì»¬ ì›ê³  ëª¨ë“œ -->
              <template v-if="!autoGenerateDraft">
                <Button
                  size="md"
                  color="primary"
                  :loading="isPublishing"
                  :disabled="loginStatus !== 'LOGGED_IN' || isBotRunning"
                  class="action-btn"
                  @click="handlePublish"
                >
                  ë°œí–‰í•˜ê¸°
                </Button>
                <Button
                  v-if="!isBotRunning"
                  size="md"
                  color="success"
                  :disabled="isPublishing"
                  class="action-btn"
                  @click="handleStartBot"
                >
                  ìë™í™” ì‹œì‘
                </Button>
              </template>
              <!-- ì›ê³  ìë™ìƒì„± ëª¨ë“œ -->
              <template v-else>
                <Button
                  v-if="!isBotRunning"
                  size="md"
                  color="primary"
                  :disabled="keywordList.length === 0"
                  class="action-btn full-width"
                  @click="handleAutoBot"
                >
                  ì›ê³ ìƒì„± + ë°œí–‰ ì‹œì‘
                </Button>
              </template>
              <!-- ì¤‘ì§€ ë²„íŠ¼ -->
              <Button
                v-if="isBotRunning"
                size="md"
                color="danger"
                class="action-btn"
                @click="handleStopBot"
              >
                ì¤‘ì§€
              </Button>
            </div>
          </div>
        </Card>
      </div>

      <!-- ì˜¤ë¥¸ìª½: ë¡œê·¸ íŒ¨ë„ -->
      <div class="log-panel">
        <Card class="panel-card log-card">
          <template #header>
            <div class="log-header">
              <h2 class="panel-title">ì‹¤í–‰ ë¡œê·¸</h2>
              <button class="clear-btn" @click="clearLogs">
                ì§€ìš°ê¸°
              </button>
            </div>
          </template>

          <div ref="logContainer" class="log-container">
            <div
              v-for="log in logs"
              :key="log.id"
              :class="['log-entry', getLogClass(log.type)]"
            >
              <span class="log-icon">{{ getLogIcon(log.type) }}</span>
              <span class="log-time">{{ formatTime(log.timestamp) }}</span>
              <span class="log-message">{{ log.message }}</span>
              <span v-if="log.detail" class="log-detail">{{ log.detail }}</span>
            </div>
            <div v-if="logs.length === 0" class="log-empty">
              ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤
            </div>
          </div>
        </Card>
      </div>
    </div>
  </div>
</template>

<style scoped>
.bot-page {
  padding: 24px;
  min-height: 100vh;
  background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
}

.bot-container {
  display: grid;
  grid-template-columns: 380px 1fr;
  gap: 24px;
  max-width: 1400px;
  margin: 0 auto;
  height: calc(100vh - 48px);
}

.settings-panel,
.log-panel {
  height: 100%;
  overflow: hidden;
}

.panel-card {
  height: 100%;
  background: rgba(255, 255, 255, 0.03);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 16px;
  overflow: hidden;
}

.panel-card :deep(.card-body) {
  padding: 0;
  height: 100%;
  display: flex;
  flex-direction: column;
}

/* ì„¹ì…˜ ê³µí†µ */
.section {
  padding: 20px 24px;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.section-title {
  margin: 0;
  font-size: 14px;
  font-weight: 600;
  color: #a0aec0;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.divider {
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
  margin: 0;
}

/* ìƒíƒœ ë°°ì§€ */
.status-badge {
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}

.status-out {
  background: rgba(160, 174, 192, 0.2);
  color: #a0aec0;
}

.status-loading {
  background: rgba(251, 191, 36, 0.2);
  color: #fbbf24;
  animation: pulse 1.5s ease-in-out infinite;
}

.status-in {
  background: rgba(16, 185, 129, 0.2);
  color: #10b981;
}

.status-error {
  background: rgba(239, 68, 68, 0.2);
  color: #ef4444;
}

/* ë¡œê·¸ì¸ ì„¹ì…˜ */
.account-mode-toggle {
  display: flex;
  gap: 4px;
  padding: 4px;
  background: rgba(15, 23, 42, 0.4);
  border-radius: 8px;
  margin-bottom: 14px;
}

.mode-btn {
  flex: 1;
  padding: 8px 12px;
  font-size: 12px;
  font-weight: 500;
  color: #94a3b8;
  background: transparent;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.mode-btn:hover {
  color: #e2e8f0;
}

.mode-btn.active {
  background: rgba(99, 102, 241, 0.3);
  color: #e2e8f0;
}

.login-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 16px;
}

.account-display {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.account-id {
  font-size: 15px;
  font-weight: 500;
  color: #e2e8f0;
}

.account-count {
  font-size: 11px;
  color: #64748b;
}

.login-btn {
  min-width: 80px;
}

.manual-login-form {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.manual-login-form .form-field {
  margin: 0;
}

.manual-login-form .field-input {
  height: 38px;
}

/* ì˜µì…˜ ì„¹ì…˜ */
.options-section .section-title {
  margin-bottom: 16px;
}

.options-grid {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.option-card {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 16px;
  background: rgba(255, 255, 255, 0.02);
  border: 1px solid rgba(255, 255, 255, 0.06);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.option-card:hover {
  background: rgba(255, 255, 255, 0.04);
  border-color: rgba(255, 255, 255, 0.1);
}

.option-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.option-name {
  font-size: 14px;
  font-weight: 500;
  color: #e2e8f0;
}

.option-desc {
  font-size: 11px;
  color: #64748b;
}

/* ì˜ˆì•½ ì„¤ì • */
.schedule-section {
  background: rgba(99, 102, 241, 0.05);
  border-top: 1px solid rgba(99, 102, 241, 0.1);
  border-bottom: 1px solid rgba(99, 102, 241, 0.1);
}

.schedule-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
}

.schedule-field {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.field-label {
  font-size: 11px;
  font-weight: 500;
  color: #94a3b8;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.field-input {
  height: 40px;
  padding: 0 12px;
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  font-size: 14px;
  color: #e2e8f0;
  transition: all 0.2s ease;
}

.field-input:focus {
  outline: none;
  border-color: #6366f1;
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
}

.date-input {
  color-scheme: dark;
}

.time-input-wrap {
  display: flex;
  align-items: center;
  gap: 8px;
}

.time-input {
  width: 70px;
  text-align: center;
}

.time-suffix {
  font-size: 13px;
  color: #64748b;
}

.schedule-hint {
  margin: 12px 0 0;
  font-size: 11px;
  color: #64748b;
  text-align: center;
}

/* ì›ê³  ìƒì„± í¼ */
.generate-section {
  background: rgba(16, 185, 129, 0.05);
  border-top: 1px solid rgba(16, 185, 129, 0.1);
  border-bottom: 1px solid rgba(16, 185, 129, 0.1);
}

.generate-form {
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.form-field {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  align-items: end;
}

.field-textarea {
  padding: 10px 12px;
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  font-size: 13px;
  color: #e2e8f0;
  resize: vertical;
  min-height: 80px;
  font-family: inherit;
  transition: all 0.2s ease;
}

.field-textarea:focus {
  outline: none;
  border-color: #10b981;
  box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
}

.field-textarea::placeholder {
  color: #64748b;
}

.field-hint {
  font-size: 10px;
  color: #10b981;
  text-align: right;
}

.option-item-inline {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: #e2e8f0;
  cursor: pointer;
}

.form-field-inline {
  display: flex;
  align-items: center;
  gap: 8px;
}

.form-field-inline .field-label {
  margin: 0;
  white-space: nowrap;
}

.field-input-sm {
  width: 70px;
  height: 32px;
  padding: 0 8px;
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 6px;
  font-size: 13px;
  color: #e2e8f0;
  text-align: center;
}

.field-input-sm:focus {
  outline: none;
  border-color: #10b981;
}

.full-width {
  width: 100%;
}

/* ì•¡ì…˜ ë²„íŠ¼ */
.action-section {
  margin-top: auto;
  padding: 20px 24px 24px;
}

.action-buttons {
  display: flex;
  gap: 12px;
}

.action-btn {
  flex: 1;
  height: 44px;
  font-weight: 600;
}

/* ë¡œê·¸ íŒ¨ë„ */
.log-card {
  display: flex;
  flex-direction: column;
}

.log-card :deep(.card-header) {
  padding: 16px 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.06);
}

.log-card :deep(.card-body) {
  flex: 1;
  overflow: hidden;
  padding: 0;
}

.log-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.panel-title {
  margin: 0;
  font-size: 15px;
  font-weight: 600;
  color: #e2e8f0;
}

.clear-btn {
  padding: 6px 12px;
  font-size: 12px;
  font-weight: 500;
  color: #64748b;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.clear-btn:hover {
  background: rgba(255, 255, 255, 0.08);
  color: #94a3b8;
}

.log-container {
  height: 100%;
  overflow-y: auto;
  padding: 12px 16px;
  font-family: 'JetBrains Mono', 'SF Mono', Monaco, monospace;
  font-size: 12px;
  background: rgba(15, 23, 42, 0.4);
}

.log-entry {
  display: flex;
  gap: 10px;
  padding: 8px 12px;
  border-radius: 8px;
  margin-bottom: 4px;
  align-items: flex-start;
  transition: background 0.15s ease;
}

.log-entry:hover {
  background: rgba(255, 255, 255, 0.03);
}

.log-icon {
  flex-shrink: 0;
  font-size: 11px;
}

.log-time {
  flex-shrink: 0;
  color: #475569;
  font-size: 11px;
}

.log-message {
  color: #cbd5e1;
  word-break: break-word;
}

.log-detail {
  color: #64748b;
  font-size: 11px;
  word-break: break-all;
}

.log-info { background: rgba(59, 130, 246, 0.08); }
.log-success { background: rgba(16, 185, 129, 0.08); }
.log-error { background: rgba(239, 68, 68, 0.12); }
.log-warning { background: rgba(251, 191, 36, 0.08); }

.log-info .log-message { color: #60a5fa; }
.log-success .log-message { color: #34d399; }
.log-error .log-message { color: #f87171; }
.log-error .log-detail { color: #fca5a5; }
.log-warning .log-message { color: #fbbf24; }

.log-empty {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: #475569;
  font-size: 13px;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

/* í´ë” ì—…ë¡œë“œ ì„¹ì…˜ */
.upload-section {
  background: rgba(59, 130, 246, 0.05);
  border-top: 1px solid rgba(59, 130, 246, 0.1);
  border-bottom: 1px solid rgba(59, 130, 246, 0.1);
}

.drop-zone {
  padding: 32px 20px;
  border: 2px dashed rgba(99, 102, 241, 0.3);
  border-radius: 12px;
  background: rgba(15, 23, 42, 0.4);
  text-align: center;
  cursor: pointer;
  transition: all 0.2s ease;
}

.drop-zone:hover,
.drop-zone-active {
  border-color: #6366f1;
  background: rgba(99, 102, 241, 0.1);
}

.drop-zone-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

.drop-icon {
  font-size: 32px;
}

.drop-text {
  margin: 0;
  font-size: 14px;
  font-weight: 500;
  color: #e2e8f0;
}

.drop-hint {
  margin: 0;
  font-size: 11px;
  color: #64748b;
}

.folder-list {
  margin-top: 16px;
}

.folder-list-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.folder-count {
  font-size: 12px;
  font-weight: 500;
  color: #94a3b8;
}

.clear-folder-btn {
  padding: 4px 8px;
  font-size: 11px;
  color: #ef4444;
  background: transparent;
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.clear-folder-btn:hover {
  background: rgba(239, 68, 68, 0.1);
}

.folder-items {
  list-style: none;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  gap: 6px;
  max-height: 150px;
  overflow-y: auto;
}

.folder-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.06);
  border-radius: 8px;
}

.folder-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.folder-name {
  font-size: 13px;
  font-weight: 500;
  color: #e2e8f0;
}

.folder-meta {
  font-size: 11px;
  color: #64748b;
}

.remove-folder-btn {
  width: 22px;
  height: 22px;
  padding: 0;
  font-size: 14px;
  color: #64748b;
  background: transparent;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.15s ease;
}

.remove-folder-btn:hover {
  color: #ef4444;
  background: rgba(239, 68, 68, 0.1);
}

.upload-btn {
  margin-top: 12px;
}

@media (max-width: 900px) {
  .bot-container {
    grid-template-columns: 1fr;
    height: auto;
  }

  .settings-panel {
    height: auto;
  }

  .log-panel {
    height: 400px;
  }
}
</style>
